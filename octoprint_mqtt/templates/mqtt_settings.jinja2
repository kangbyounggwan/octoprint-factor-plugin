<!-- settings_plugin_factor_mqtt 의 컨텐츠만 넣어야 합니다. tab-pane 같은 래퍼 금지 -->
<div id="settings_plugin_factor_mqtt" class="factor-mqtt">
  <ul class="nav nav-tabs" style="margin-bottom:10px;">
    <li data-bind="css: { active: wizardStep() === 1 }"><a href="#" data-step="1">1. 로그인</a></li>
    <li data-bind="css: { active: wizardStep() === 2 }"><a href="#" data-step="2">2. 등록</a></li>
    <li data-bind="css: { active: wizardStep() === 3 }"><a href="#" data-step="3">3. MQTT 설정</a></li>
  </ul>

  <div id="tab-login" data-bind="visible: wizardStep() === 1" style="margin-bottom:12px;">
    <div style="margin-bottom:8px;">
      <div style="font-size:18px; font-weight:bold;">FACTOR LOGIN</div>
      <div style="font-size:12px; color:#666;">FACTOR 플랫폼에 로그인하세요</div>
    </div>
    <div class="form-group" style="max-width:520px;">
      <label for="fm-login-id">ID</label>
      <input type="text" id="fm-login-id" class="form-control" placeholder="Email" />
    </div>
    <div class="form-group" style="max-width:520px;">
      <label for="fm-login-pw">PW</label>
      <input type="password" id="fm-login-pw" class="form-control" placeholder="Password" />
    </div>
    <div class="form-group" style="max-width:520px;">
      <button id="fm-login-btn" class="btn btn-primary">로그인</button>
      <span id="fm-login-status" class="text-muted" style="margin-left:8px;"></span>
    </div>
  </div>

  <div id="tab-register" data-bind="visible: wizardStep() === 2" style="margin-bottom:12px;">
    <h4>프린터 연동</h4>
    <div class="form-inline" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:6px;">
      <select id="fm-register-select" class="form-control" style="min-width:220px;">
        <option value="__new__">신규 등록</option>
      </select>
    </div>
    <div class="form-inline" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <input type="text" id="fm-instance-id" class="form-control" placeholder="Instance ID (UUID)" style="min-width:260px;">
      <button id="fm-instance-gen" class="btn btn-default btn-sm">생성</button>
    </div>
    <div id="fm-register-conn" style="margin-top:8px;"></div>

    <hr/>

    <div id="fm-camera-section">
      <h4>카메라 연동 (선택)</h4>
      <div class="form-inline" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <input type="text" id="fm-camera-url" class="form-control" placeholder="http://&lt;ip&gt;:&lt;port&gt;/stream" style="min-width:320px;"
               data-bind="value: cameraStreamUrl, valueUpdate: 'afterkeydown'">
        <button id="fm-camera-test" class="btn">Test</button>
        <button id="fm-camera-save" class="btn btn-primary">저장</button>
        <span id="fm-camera-status" class="text-muted"></span>
      </div>
      <p class="help-block">브라우저에서 접근 가능한 MJPEG/HTTP 스트림 URL을 입력하세요.</p>
    </div>
  <div class="right-actions">
    <button id="fm-register-btn" class="btn btn-primary btn-sm">등록</button>
    <button id="fm-register-next" class="btn btn-default btn-sm" style="display:none;">다음</button>
    <span id="fm-register-status" class="text-muted"></span>
  </div>
</div>

<style>
  .right-actions{
    display:flex; justify-content:flex-end; align-items:center; gap:8px; margin-top:10px;
  }
</style>

  <div id="tab-mqtt" data-bind="visible: wizardStep() === 3">
  <div class="row">
    <div class="col-xs-12 col-md-6">
      <h4>MQTT 브로커 설정</h4>

      <div class="form-group">
        <label for="mqtt_broker_host">브로커 호스트</label>
        <input type="text" class="form-control" id="mqtt_broker_host"
               data-bind="value: brokerHost" placeholder="localhost">
        <p class="help-block">MQTT 브로커의 호스트명 또는 IP.</p>
      </div>

      <div class="form-group">
        <label for="mqtt_broker_port">브로커 포트</label>
        <input type="number" class="form-control" id="mqtt_broker_port"
               data-bind="value: brokerPort" min="1" max="65535" placeholder="1883">
        <p class="help-block">기본값: 1883</p>
      </div>

      <div class="form-group">
        <label for="mqtt_broker_username">사용자명 (선택)</label>
        <input type="text" class="form-control" id="mqtt_broker_username"
               data-bind="value: brokerUsername" placeholder="username">
      </div>

      <div class="form-group">
        <label for="mqtt_broker_password">비밀번호 (선택)</label>
        <input type="password" class="form-control" id="mqtt_broker_password"
               data-bind="value: brokerPassword" placeholder="password">
      </div>

      <div class="form-group">
        <label for="mqtt_topic_prefix">토픽 접두사</label>
        <input type="text" class="form-control" id="mqtt_topic_prefix"
               data-bind="value: topicPrefix" placeholder="octoprint">
        <p class="help-block">모든 발행 토픽 앞에 붙는 접두사.</p>
      </div>
    </div>

    <div class="col-xs-12 col-md-6">
      <h4>발행 설정</h4>

      <div class="form-group">
        <label for="mqtt_qos_level">QoS 레벨</label>
        <select class="form-control" id="mqtt_qos_level" data-bind="value: qosLevel">
          <option value="0">0 - 최대 한 번</option>
          <option value="1">1 - 최소 한 번</option>
          <option value="2">2 - 정확히 한 번</option>
        </select>
        <p class="help-block">메시지 전달 보장 수준을 선택하세요.</p>
      </div>

      <div class="checkbox">
        <label>
          <input type="checkbox" data-bind="checked: retainMessages">
          메시지 유지(Retain)
        </label>
      </div>

       <h5>발행할 이벤트</h5>
       <div class="checkbox"><label><input type="checkbox" data-bind="checked: publishStatus"> 프린터 상태 변경</label></div>
       <div class="checkbox"><label><input type="checkbox" data-bind="checked: publishProgress"> 인쇄 진행률</label></div>
       <div class="checkbox"><label><input type="checkbox" data-bind="checked: publishTemperature"> 온도 정보</label></div>
       <div class="checkbox"><label><input type="checkbox" data-bind="checked: publishGcode"> G-code 명령</label></div>
       <div class="checkbox"><label><input type="checkbox" data-bind="checked: publishSnapshot"> 스냅샷 전송</label></div>
       
       <div class="form-group" data-bind="visible: publishSnapshot">
         <label for="periodic_interval">스냅샷 전송 간격 (초)</label>
         <input type="number" class="form-control" id="periodic_interval" 
                data-bind="value: periodicInterval" min="0.1" max="60" step="0.1" placeholder="1.0">
         <p class="help-block">스냅샷을 전송할 간격을 설정하세요 (기본값: 1.0초)</p>
       </div>
    </div>
  </div>

  <hr/>

  <h4>연결 상태</h4>
  <div id="mqtt_connection_status" class="alert alert-info"
       data-bind="text: connectionStatus">MQTT 연결 상태를 확인하는 중...</div>

  <button type="button" class="btn btn-primary" data-bind="click: testConnection">
    <span class="glyphicon glyphicon-refresh"></span> 연결 테스트
  </button>
  </div>
</div>

<div id="cameraStreamModal" class="modal hide fade" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal">×</button>
    <h3>Stream test</h3>
  </div>
  <div class="modal-body" style="text-align:center;">
    <img id="cameraStreamPreview" style="max-width:100%; max-height:60vh;" />
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal">Close</button>
  </div>
</div>
